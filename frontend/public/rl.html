<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Force viewport to 1920x1080 for fixed layout -->
    <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0">
    <title>Dnevni Raspored Letova</title>
    <style>
        /* Redizajniran CSS za rl.html - Fiksni Layout, Tamno Plava Tema, Glassmorphism */

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 1080px; /* Fiksna visina */
            width: 1920px; /* Fiksna širina */
            overflow: hidden; /* Nema skrolovanja */
            background-color: #020617; /* Very dark blue */
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            color: #e2e8f0; /* Light grayish blue */
            box-sizing: border-box;
        }

        /* Main container */
        .public-schedule-container {
            height: 100%;
            width: 100%;
            padding: 30px 40px; /* Više paddinga */
            /* Creative radial gradient */
            background: radial-gradient(ellipse at top, #1a2a6c 0%, #0b0f19 60%, #020617 100%);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
        }

         /* Optional subtle background pattern */
        .public-schedule-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(203, 213, 225, 0.03) 1px, transparent 1px);
            background-size: 25px 25px;
            opacity: 0.5;
            z-index: 0;
        }

        /* Header for Departures Title and Date/Time */
        .departures-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 15px; /* Space below header */
            flex-shrink: 0;
            position: relative; /* Ensure content stays above background pattern */
            z-index: 1;
        }

        /* Header for Arrivals Title */
        .arrivals-header {
            display: flex; /* Keep flex for potential future elements */
            justify-content: flex-start; /* Align title left */
            align-items: center;
            width: 100%;
            margin-top: 25px; /* Space above arrivals header */
            margin-bottom: 15px; /* Space below header */
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }


        .schedule-datetime {
            text-align: right;
            font-size: 26px;
            font-weight: 400;
            color: #94a3b8; /* Lighter gray-blue */
            /* Removed display: block from span */
        }
         /* Adjust font size for inline display */
         #current-datetime-display { font-weight: 600; color: #e2e8f0; font-size: 38px; } /* Adjusted size */


        /* Section title styling */
        .public-section-title {
            font-size: 34px;
            color: #e0f2fe; /* Light sky blue */
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            font-weight: 500;
            margin: 0;
            text-transform: uppercase;
        }
         .public-section-title svg {
             width: 50px;
             height: 50px;
             fill: #64b5f6; /* Light blue icon */
         }


        /* Sections container */
        .public-schedule-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex-grow: 1; /* Takes remaining vertical space */
            overflow: hidden; /* Hide overflow */
            position: relative; /* Ensure content stays above background pattern */
            z-index: 1;
        }

        /* Individual section styling (Departures/Arrivals) */
        .public-departures,
        .public-arrivals {
            background: rgba(0, 0, 0, 0.3); /* Slightly more opaque glass */
            border: 1px solid rgba(51, 65, 85, 0.5); /* Slate border */
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            flex-basis: 0; /* Equal height distribution */
            flex-grow: 1; /* Grow to fill space */
            overflow: hidden; /* Hide overflow */
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.85), 0 0 0 1px rgba(30, 64, 175, 0.25), 0 0 20px rgba(37, 99, 235, 0.2);
            backdrop-filter: blur(20px); /* Further increased blur */
            -webkit-backdrop-filter: blur(20px);
        }

        /* Table container - no scroll */
        .table-container {
            flex-grow: 1;
            overflow: hidden; /* No scroll */
            position: relative;
        }

        /* Table styling */
        .public-flight-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }

        /* Column widths - adjust percentages/pixels for 1920 width */
        /* Adjusted widths to accommodate Status column */
        .narrow-column { width: 4%; text-align: center; }
        .brojleta { width: 10%; text-align: center; }
        .airline-col { width: 18%; } /* Kept reduced */
        .vrijeme { width: 8%; text-align: center; }
        .destination-col { width: 20%; } /* Further Reduced */
        .status-col { width: 15%; } /* Kept */
        .remarks-col { width: 25%; } /* Increased */


        /* Table header */
        .public-flight-table th {
            /* Background moved to thead */
            color: #cbd5e1; /* Lighter text */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 14px 12px; /* Adjust padding */
            text-align: center;
            border-bottom: 1px solid rgba(71, 85, 105, 0.6); /* Stronger border */
            font-size: 18px; /* Slightly smaller header font */
            position: sticky;
            top: 0;
            z-index: 2;
        }
         /* Apply background to thead instead of th */
         .public-flight-table thead {
            background-color: #1e293b; /* Solid background on thead */
            position: relative; /* Establish stacking context */
            z-index: 1; /* Ensure thead is above tbody */
         }
         .public-flight-table th:first-child { border-top-left-radius: 10px; }
         .public-flight-table th:last-child { border-top-right-radius: 10px; }

         /* Ensure tbody is below thead */
         .public-flight-table tbody {
            position: relative; /* Establish stacking context */
             z-index: 0; /* Place tbody below thead */
             /* Removed max-height, display: block, overflow: hidden */
         }

        /* Table cells */
        .public-flight-table td {
            padding: 12px 12px; /* Adjust padding */
            text-align: center; /* Center text by default */
            border-bottom: 1px solid rgba(51, 65, 85, 0.4); /* Subtle border */
            word-wrap: break-word;
            vertical-align: middle;
            font-size: 29px; /* Adjust font size */
            background-color: transparent; /* Let section background show through */
            color: #e2e8f0;
            height: 53px; /* Slightly reduced height per row */
            box-sizing: border-box;
        }

        /* Left-align airline column specifically */
        .public-flight-table td.airline-col {
            text-align: left;
        }
        /* Center status column */
        .public-flight-table td.status-col {
            text-align: center;
            font-weight: bold; /* Make status bold */
        }

        /* Alternating row styling */
        .public-flight-table tbody tr:nth-of-type(even) td {
            background-color: rgba(51, 65, 85, 0.15); /* Slightly more visible alternating row */
        }


        /* Airline info */
        .public-airline-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Airline logo */
        .public-airline-logo {
            width: 120px; /* Adjust size as needed */
            height: 75px; /* Fixed height for cover */
            max-height: 50px; /* Limit height */
            border-radius: 13px; /* Updated border radius */
            object-fit: cover; /* Use cover */
            vertical-align: middle;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 2px;
            border: 1px solid rgba(100, 181, 246, 0.2);
        }

        /* Specific text styles */
        .destination1, .dolazak1, .bilješke1, .brojleta1, .status1 { /* Added .status1 */
            font-size: 35px; /* Adjusted font size */
            font-weight: 400;
        }
        .brojleta1 { font-family: 'Consolas', 'Menlo', monospace; color: #94a3b8; }
        .dolazak1 { color: #f1f5f9; font-weight: 600; }
        .destination1 { font-weight: 500; color: #ffffff; }
        .bilješke1 { color: #94a3b8; font-style: italic; }
        /* .status1 { font-weight: bold; } /* Style for status text - moved to status-box */

        /* New style for the status box */
        .status-box {
            color: white; /* Text color is always white */
            padding: 5px 10px; /* Padding inside the box */
            border-radius: 12px; /* Rounded corners */
            display: inline-block; /* Allows setting padding/width */
            text-align: center; /* Center text inside */
            font-weight: bold; /* Keep text bold */
            font-size: 20px; /* Reduced font size */
            min-width: 120px; /* Minimum width for consistency */
            line-height: 1.3; /* Adjust line height if needed */
            box-sizing: border-box;
        }

        /* Loading spinner - REMOVED */
        /*
        .public-spinner { ... }
        @keyframes spin { ... }
        */

        /* Error message */
        .public-error {
            text-align: center;
            margin: 40px auto;
            max-width: 600px;
            padding: 20px;
            background: rgba(239, 83, 80, 0.1);
            border-left: 4px solid #ef5350;
            border-radius: 8px;
            color: #ef9a9a;
            font-size: 18px;
        }

        /* Hide elements */
        .hidden { display: none !important; }

        /* Infinite Scroll Animation - REMOVED */
        /*
        @keyframes scrollUp { ... }
        .infinite-scroll > tbody { ... }
        */

    </style>
</head>
<body>
    <div class="public-schedule-container">

        <!-- Header for Departures and Time -->
        <div class="departures-header">
             <h2 class="public-section-title">
                 <!-- Departure SVG Icon -->
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30px" height="30px">
                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                 </svg>
                  ODLASCI / DEPARTURES
              </h2>
             <div class="schedule-datetime">
                 <span id="current-datetime-display">--:--, --.--.----</span>
             </div>
         </div>

        <!-- Loading indicator removed -->
        <div id="error-message" class="public-error hidden"></div>

        <!-- Content Area (Tables) -->
        <div class="public-schedule-content">
            <!-- Departures Section -->
            <div class="public-departures">
                <div class="table-container">
                    <table class="public-flight-table">
                        <thead>
                            <tr>
                                <th class="narrow-column">BR.</th>
                                <th class="brojleta">LET/FLIGHT</th>
                                <th class="airline-col">AVIOKOMPANIJA/AIRLINES</th>
                                <th class="vrijeme">VRIJEME/TIME</th>
                                <th class="destination-col">DESTINACIJA/DESTINATION</th>
                                <th class="status-col">STATUS</th>
                                <th class="remarks-col">NAPOMENE/REMARKS</th>
                            </tr>
                        </thead>
                        <tbody id="departures-body">
                            <!-- Rows will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

             <!-- Header for Arrivals -->
             <div class="arrivals-header">
                 <h2 class="public-section-title">
                     <!-- Arrival SVG Icon -->
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30px" height="30px">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" transform="rotate(180 12 12)"/>
                     </svg>
                     DOLASCI / ARRIVALS
                 </h2>
             </div>

            <!-- Arrivals Section -->
            <div class="public-arrivals">
                <div class="table-container">
                    <table class="public-flight-table">
                        <thead>
                            <tr>
                                <th class="narrow-column">BR.</th>
                                <th class="brojleta">LET/FLIGHT</th>
                                <th class="airline-col">AVIOKOMPANIJA/AIRLINES</th>
                                <th class="vrijeme">VRIJEME/TIME</th>
                                <th class="destination-col">PORIJEKLO/ORIGIN</th>
                                <th class="status-col">STATUS</th> 
                                <th class="remarks-col">NAPOMENE/REMARKS</th>
                            </tr>
                        </thead>
                        <tbody id="arrivals-body">
                            <!-- Rows will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
        (function() {
            // --- Configuration ---
            // var API_BASE_URL = 'https://fids-hqlz.onrender.com'; // Uklonjeno
            var API_URL = 'http://192.168.18.15:5001/public/daily-schedule';
            var BACKEND_BASE_URL = 'http://192.168.18.15:5001'; // Added Backend Base URL
            var REFRESH_INTERVAL = 120000; // 2 minutes
            var ROWS_PER_PAGE = 4; // Reduced rows per page to prevent clipping
            // var MAX_STATIC_ROWS = 8; // No longer needed, pagination handles all cases
            var ROTATION_INTERVAL = 15000; // Rotate pages every 15 seconds
            var DEFAULT_LOGO = '/default-logo.png';
            // var SCROLL_SPEED_PER_ROW = 8; // No longer needed
            var MAX_RETRIES = 3;
            var RETRY_DELAY = 5000; // 5 seconds

            // Status Colors - Use display labels as keys
            var statusColors = {
              'Scheduled': '#43A9DD',  // Pastel Blue
              'Check-in': '#088280',   // Pastel Green
              'Delayed': '#FF8300',    // Pastel Peach/Orange
              'Boarding': '#703ACF', // Pastel Purple
              'Departed': '#703ACF',  // Pastel Purple (same as boarding)
              'Cancelled': '#DB1F48',   // Pastel Red
              'Diverted': '#F95450', // Pastel Coral/Orange
              'Landed': '#088280',   // Pastel Green (same as on time)
              'default': '#64748b' // Default background color (e.g., slate-500)
            };

            // Map backend status values to display labels
            var statusDisplayLabels = {
              'SCHEDULED': 'Scheduled',
              'ON_TIME': 'Check-in',
              'DELAYED': 'Delayed',
              'BOARDING': 'Boarding',
              'DEPARTED': 'Departed',
              'CANCELLED': 'Cancelled',
              'DIVERTED': 'Diverted',
              'ARRIVED': 'Landed'
            };

            function getStatusColor(status) {
              // Map backend status to display label key used in statusColors
              var displayLabel = statusDisplayLabels[status] || status; // Fallback to original status if no label
              return statusColors[displayLabel] || statusColors['default'];
            }

            function getStatusDisplayLabel(status) {
                return statusDisplayLabels[status] || status || ''; // Return label or original status or empty string
            }


            // --- State ---
            var allFlights = [];
            var currentDeparturePage = 0;
            var currentArrivalPage = 0;
            var rotationTimer = null;
            var consecutiveFetchErrors = 0; // Added
            var MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE = 3; // Added

             // --- DOM Elements ---
             var dateTimeDisplay = document.getElementById('current-datetime-display'); // Updated ID
             var departuresTableBody = document.getElementById('departures-body');
             var arrivalsTableBody = document.getElementById('arrivals-body');
             // var loadingIndicator = document.getElementById('loading-indicator'); // Removed
            var errorMessage = document.getElementById('error-message');

            // NEW INITIAL DOM CHECK (MOVED AND MODIFIED FROM '--- Initialization ---' SECTION)
            if (!departuresTableBody || !arrivalsTableBody || !dateTimeDisplay) {
                console.error("Critical DOM elements (departures-body, arrivals-body, or current-datetime-display) not found. Aborting FIDS script initialization.");
                return; // Stop script execution if essential elements are missing
            }

            // --- Utility Functions ---
            function padStart(str, targetLength, padString) {
                str = String(str);
                padString = String(padString || ' ');
                if (str.length >= targetLength) { return str; }
                var padding = padString;
                while (padding.length < targetLength - str.length) { padding += padString; }
                return padding.slice(0, targetLength - str.length) + str;
            }

            function formatDateTimeForDisplay(date) {
                var hours = padStart(date.getHours(), 2, '0');
                var minutes = padStart(date.getMinutes(), 2, '0');
                 var day = padStart(date.getDate(), 2, '0');
                 var month = padStart(date.getMonth() + 1, 2, '0'); // Months are 0-indexed
                 var year = date.getFullYear();
                 // Combine time and date into one string
                 var dateTimeString = hours + ':' + minutes + ', ' + day + '.' + month + '.' + year;
                 if (dateTimeDisplay) dateTimeDisplay.textContent = dateTimeString; // Update single element
             }

             function formatTimeHoursMinutes(dateString) {
                try {
                    var date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        console.warn("Invalid date string received:", dateString);
                        return '--:--';
                    }
                    var hours = padStart(date.getHours(), 2, '0');
                    var minutes = padStart(date.getMinutes(), 2, '0');
                    return hours + ':' + minutes;
                } catch (e) {
                    console.error("Error formatting time:", dateString, e);
                    return '--:--';
                }
            }

            function showLoading() {
                // if (loadingIndicator) loadingIndicator.classList.remove('hidden'); // Removed
                if (errorMessage) errorMessage.classList.add('hidden');
            }

            function showError(message) {
                console.log("[RL_DEBUG] showError called with message:", message);
                if (errorMessage) {
                    errorMessage.textContent = message;
                    errorMessage.classList.remove('hidden');
                }
                // if (loadingIndicator) loadingIndicator.classList.add('hidden'); // Removed
            }

            function hideStatus() {
                console.log("[RL_DEBUG] hideStatus called.");
                // if (loadingIndicator) loadingIndicator.classList.add('hidden'); // Removed
                if (errorMessage) errorMessage.classList.add('hidden');
            }

            // --- Clock Update ---
            function updateClock() {
                formatDateTimeForDisplay(new Date());
            }

            // --- Data Fetching ---
            function fetchData(retryCount) {
                retryCount = retryCount || 0; // Initialize retry count
                console.log('Fetching flight data... (Attempt ' + (retryCount + 1) + ')');
                showLoading(); // Show loading might need adjustment if retrying silently

                var xhr = new XMLHttpRequest();
                var urlWithCacheBuster = API_URL + '?t=' + Date.now(); // API_URL je već relativan
                xhr.open('GET', urlWithCacheBuster, true);
                xhr.timeout = 15000;

                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                console.log("[RL_DEBUG] API Data Parsed:", JSON.stringify(data).substring(0, 500));
                                if (Array.isArray(data)) {
                                    allFlights = data;
                                    consecutiveFetchErrors = 0; // Added - Reset on success
                                    console.log("[RL_DEBUG] Data is array. Calling updateTables. Hiding error message.");
                                    hideStatus();
                                    updateTables();
                                } else {
                                    consecutiveFetchErrors++; // Added
                                    console.error('[RL_DEBUG] Invalid data format received (not an array):', data);
                                    console.error('Invalid data format received:', data);
                                    if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE || allFlights.length === 0) { // Added condition
                                        showError('Greška: Neočekivani format podataka.');
                                    }
                                    // No retry on invalid format
                                }
                            } catch (err) {
                                consecutiveFetchErrors++; // Added
                                console.error('[RL_DEBUG] JSON parsing error:', err.message, 'Response Text:', xhr.responseText.substring(0, 500));
                                console.error('Greška pri parsiranju JSON-a:', err, xhr.responseText);
                                if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE || allFlights.length === 0) { // Added condition
                                    showError('Greška pri obradi podataka.');
                                }
                                // No retry on parsing error
                            }
                        } else { // Handle HTTP errors (non-200 status)
                            console.error('[RL_DEBUG] API request failed with HTTP status:', xhr.status, xhr.statusText, 'Response Text:', xhr.responseText.substring(0, 500));
                            console.error('Greška pri dobavljanju dnevnih letova:', xhr.status, xhr.statusText);
                            var errorMsg = 'Greška servera (' + xhr.status + ') pri dobavljanju podataka.';
                            if (retryCount < MAX_RETRIES) {
                                console.warn(errorMsg + ' Pokušavam ponovo za ' + RETRY_DELAY / 1000 + 's...');
                                setTimeout(function() { fetchData(retryCount + 1); }, RETRY_DELAY);
                            } else {
                                consecutiveFetchErrors++; // Added
                                console.error('Max retries reached for HTTP error. Reloading page...');
                                if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE || allFlights.length === 0) { // Added condition
                                   // showError(errorMsg); // Don't show error, just reload
                                }
                                window.location.reload(true);
                            }
                        }
                    }
                };
                xhr.onerror = function() { // Handle network errors
                    console.error('[RL_DEBUG] Network error occurred during fetchData.');
                    console.error('Network error occurred');
                    var errorMsg = 'Mrežna greška pri dobavljanju podataka.';
                    if (retryCount < MAX_RETRIES) {
                        console.warn(errorMsg + ' Pokušavam ponovo za ' + RETRY_DELAY / 1000 + 's...');
                        setTimeout(function() { fetchData(retryCount + 1); }, RETRY_DELAY);
                    } else {
                        consecutiveFetchErrors++; // Added
                        console.error('Max retries reached for network error. Reloading page...');
                        if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE || allFlights.length === 0) { // Added condition
                            // showError(errorMsg + ' Proverite konekciju.'); // Don't show error, just reload
                        }
                        window.location.reload(true);
                    }
                };
                xhr.ontimeout = function () { // Handle timeouts
                    console.error('[RL_DEBUG] Request timed out during fetchData.');
                    console.error('Request timed out');
                     var errorMsg = 'Zahtev je istekao.';
                     if (retryCount < MAX_RETRIES) {
                        console.warn(errorMsg + ' Pokušavam ponovo za ' + RETRY_DELAY / 1000 + 's...');
                        setTimeout(function() { fetchData(retryCount + 1); }, RETRY_DELAY);
                    } else {
                        consecutiveFetchErrors++; // Added
                        console.error('Max retries reached for timeout. Reloading page...');
                        if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE || allFlights.length === 0) { // Added condition
                           // showError(errorMsg + ' Pokušavam ponovo...'); // Don't show error, just reload
                        }
                        window.location.reload(true);
                    }
                };
                xhr.send();
            }

            // --- Table Rendering ---
            // Renders a specific page of flights
            function renderTableRows(tbodyElement, flightsToRender, pageIndex, rowsPerPage) {
                tbodyElement.innerHTML = ''; // Clear existing rows
                var startIndex = pageIndex * rowsPerPage;
                var endIndex = startIndex + rowsPerPage;
                var pageFlights = flightsToRender.slice(startIndex, endIndex);

                for (var i = 0; i < pageFlights.length; i++) {
                    var flight = pageFlights[i];
                    var displayIndex = startIndex + i + 1; // Calculate correct row number

                    try {
                        var airlineName = (flight && flight.Airline && flight.Airline.name) ? flight.Airline.name : 'N/A';

                        var logoUrl = DEFAULT_LOGO;
                        if (flight && flight.Airline && flight.Airline.logo_url) {
                            var apiLogoUrl = flight.Airline.logo_url;
                            if (apiLogoUrl && typeof apiLogoUrl.substring === 'function' && apiLogoUrl.substring(0, '/uploads/'.length) === '/uploads/') {
                                logoUrl = BACKEND_BASE_URL + apiLogoUrl;
                            } else if (apiLogoUrl) { // Ensure apiLogoUrl is truthy before assigning
                                logoUrl = apiLogoUrl;
                            }
                        }

                        var flightNumberDisplay = (flight && flight.flight_number) ? flight.flight_number : '';
                        
                        var timeString = '--:--'; // Default value
                        if (flight) {
                            var timeProperty = flight.is_departure ? flight.departure_time : flight.arrival_time;
                            if (timeProperty) { // Check if the time property itself exists and is truthy
                                timeString = formatTimeHoursMinutes(timeProperty);
                            }
                        }

                        var destinationDisplayString = 'N/A'; // Default value
                        if (flight) {
                            if (flight.DestinationInfo && flight.DestinationInfo.name && flight.DestinationInfo.code) {
                                destinationDisplayString = flight.DestinationInfo.name + ' (' + flight.DestinationInfo.code + ')';
                            } else if (flight.destination) { // Fallback to flight.destination
                                destinationDisplayString = flight.destination;
                            }
                        }

                        var backendStatus = (flight && flight.status) ? flight.status : '';
                        var displayStatusText = getStatusDisplayLabel(backendStatus);
                        var statusColor = getStatusColor(backendStatus);

                        var remarksDisplay = (flight && flight.remarks) ? flight.remarks : '';

                        var row = document.createElement('tr');
                        row.innerHTML =
                            '<td class="narrow-column">' + displayIndex + '</td>' +
                            '<td class="brojleta1">' + flightNumberDisplay + '</td>' +
                            '<td class="airline-col">' +
                                '<div class="public-airline-info">' +
                                    '<img src="' + logoUrl + '" alt="' + airlineName + '" class="public-airline-logo" onerror="this.onerror=null;this.src=\'' + DEFAULT_LOGO + '\';">' +
                                    '<span>' + airlineName + '</span>' +
                                '</div>' +
                            '</td>' +
                            '<td class="dolazak1">' + timeString + '</td>' +
                            '<td class="destination-col destination1">' + destinationDisplayString + '</td>' +
                            '<td class="status-col">' +
                                '<span class="status-box" style="background-color: ' + statusColor + ';">' +
                                    displayStatusText +
                                '</span>' +
                            '</td>' +
                            '<td class="remarks-col bilješke1">' + remarksDisplay + '</td>';
                        
                        tbodyElement.appendChild(row);

                    } catch (error) {
                        var flightDataForLog = 'Flight data unavailable or could not be stringified.';
                        try {
                            // Ensure flight is defined before trying to stringify
                            if (typeof flight !== 'undefined') {
                                flightDataForLog = JSON.stringify(flight);
                            }
                        } catch (stringifyError) {
                            // flightDataForLog remains the default message or previous value
                        }
                        console.error('Error rendering flight row. Index: ' + displayIndex + '. Error: ' + error.message + '. Stack: ' + (error.stack || 'N/A') + '. Flight data: ' + flightDataForLog);
                    }
                }

                // Add empty rows if needed to fill the page
                var emptyRowsNeeded = rowsPerPage - pageFlights.length;
                for (var j = 0; j < emptyRowsNeeded; j++) {
                    var emptyRow = document.createElement('tr');
                    // Add 7 empty cells matching the number of columns
                    emptyRow.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td>';
                    // Optionally add a class for styling empty rows if needed
                    // emptyRow.classList.add('empty-row');
                    tbodyElement.appendChild(emptyRow);
                }
            }


            function updateTables() {
                // ADDED CHECK FOR TABLE BODIES AT THE START OF THE FUNCTION
                if (!departuresTableBody || !arrivalsTableBody) {
                    console.error("[RL_DEBUG] Table body elements (departuresTableBody or arrivalsTableBody) are null in updateTables. Aborting table update.");
                    return;
                }
                // REMOVE INCORRECT REDECLARATIONS if they exist from previous edits (model might have added these)
                // const departuresTableBody = document.getElementById('departures-table-body'); // This was an incorrect line to remove
                // const arrivalsTableBody = document.getElementById('arrivals-table-body');   // This was an incorrect line to remove
                
                // Use IIFE-scoped variables, which are checked above
                departuresTableBody.innerHTML = ''; // Clear previous rows
                arrivalsTableBody.innerHTML = ''; // Clear previous rows

                const departures = allFlights.filter(flight => flight.is_departure);
                const arrivals = allFlights.filter(flight => !flight.is_departure);

                // --- Departures ---
                let totalDeparturePages = 0;
                if (!departures || departures.length === 0) {
                    departuresTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; font-style:italic;">Nema odlazaka za danas.</td></tr>';
                    currentDeparturePage = 1; // Reset page if no data
                } else {
                    totalDeparturePages = Math.ceil(departures.length / ROWS_PER_PAGE);
                    if (currentDeparturePage > totalDeparturePages) {
                        currentDeparturePage = totalDeparturePages || 1;
                    }
                     // Ensure current page index is valid before rendering (especially for rotation)
                    if (currentDeparturePage > totalDeparturePages) currentDeparturePage = totalDeparturePages > 0 ? totalDeparturePages : 1;
                    if (currentDeparturePage < 1) currentDeparturePage = 1;

                    renderTableRows(departuresTableBody, departures, currentDeparturePage, ROWS_PER_PAGE);
                }

                // --- Arrivals ---
                let totalArrivalPages = 0;
                if (!arrivals || arrivals.length === 0) {
                    arrivalsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; font-style:italic;">Nema dolazaka za danas.</td></tr>';
                    currentArrivalPage = 1; // Reset page if no data
                } else {
                    totalArrivalPages = Math.ceil(arrivals.length / ROWS_PER_PAGE);
                    if (currentArrivalPage > totalArrivalPages) {
                        currentArrivalPage = totalArrivalPages || 1;
                    }
                    // Ensure current page index is valid before rendering
                    if (currentArrivalPage > totalArrivalPages) currentArrivalPage = totalArrivalPages > 0 ? totalArrivalPages : 1;
                    if (currentArrivalPage < 1) currentArrivalPage = 1;
                    
                    renderTableRows(arrivalsTableBody, arrivals, currentArrivalPage, ROWS_PER_PAGE);
                }
                
                // Remove scrolling classes and styles if they exist (Important for WebOS 3)
                var departuresTable = departuresTableBody.closest('.public-flight-table');
                var arrivalsTable = arrivalsTableBody.closest('.public-flight-table');
                if (departuresTable) departuresTable.classList.remove('infinite-scroll');
                if (arrivalsTable) arrivalsTable.classList.remove('infinite-scroll');
                departuresTableBody.style.animationDuration = '';
                arrivalsTableBody.style.animationDuration = '';


                // Restart rotation timer if it's not already running or needs reset
                startRotationTimer(totalDeparturePages, totalArrivalPages);
            }

            // Function to rotate pages
            function rotatePages(totalDeparturePages, totalArrivalPages) {
                currentDeparturePage = (currentDeparturePage + 1) % (totalDeparturePages || 1);
                currentArrivalPage = (currentArrivalPage + 1) % (totalArrivalPages || 1);
                updateTables(); // Re-render tables with new page indices
            }

            // Function to start/reset the rotation timer
            function startRotationTimer(totalDeparturePages, totalArrivalPages) {
                if (rotationTimer) {
                    clearInterval(rotationTimer); // Clear existing timer
                }
                // Only start timer if there's more than one page in either table
                if (totalDeparturePages > 1 || totalArrivalPages > 1) {
                     console.log('Starting page rotation timer. Interval:', ROTATION_INTERVAL);
                    rotationTimer = setInterval(function() {
                        rotatePages(totalDeparturePages, totalArrivalPages);
                    }, ROTATION_INTERVAL);
                } else {
                    console.log('No page rotation needed (single page or empty).');
                    rotationTimer = null;
                }
            }


             // --- Initialization ---
             // Removed loadingIndicator check
             // OLD CHECK IS NOW MOVED TO AFTER DOM ELEMENT DEFINITIONS.
             // if (!departuresTableBody || !arrivalsTableBody || !dateTimeDisplay) {
             //     console.error("Critical DOM elements not found. Aborting initialization.");
             //     showError("Greška pri inicijalizaciji prikaza.");
             //    return;
             // }

            updateClock();
            setInterval(updateClock, 1000); // Update clock every second

            fetchData(0); // Initial fetch (attempt 0)
            // Fetch data periodically, passing initial retry count 0
            setInterval(function() { fetchData(0); }, REFRESH_INTERVAL); // Refresh data periodically

            // --- Periodic Page Refresh ---
            function checkAndPerformRefresh() {
                var now = new Date();
                var hour = now.getHours();
                var minute = now.getMinutes();

                // Check for 4:00 AM, 8:00 AM or 16:00 (4 PM)
                if ((hour === 4 || hour === 8 || hour === 16) && minute === 0) { // Added 16:00
                    console.log('Performing scheduled refresh at ' + hour + ':00...');
                    window.location.reload(true); // Force reload from server
                }
            }
            // Check every minute for the refresh time
            setInterval(checkAndPerformRefresh, 60000);
            console.log('Scheduled refresh check active for 4:00, 8:00, and 16:00.');

            console.log('Flight schedule display initialized.');

        })();
});
    </script>
</body>
</html>
