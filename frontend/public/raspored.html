<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspored Letova - Pojednostavljena Verzija</title>
    <style>
        /* --- Base Styles --- */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: radial-gradient(ellipse at top, #1a2a6c 0%, #0b0f19 60%, #020617 100%);
            color: #f1f5f9;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* --- Container --- */
        .public-schedule-container {
            width: 1920px;
            height: 1080px;
            margin: 0 auto;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* --- Headers --- */
        .departures-header, .arrivals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 15px 20px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(26, 42, 108, 0.7) 0%, rgba(11, 15, 25, 0.8) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 181, 246, 0.2);
            box-shadow: 0 8px 32px rgba(2, 4, 24, 0.2);
        }

        .public-section-title {
            display: flex;
            align-items: center;
            font-size: 42px;
            font-weight: 600;
            color: #a3c9ff;
            margin: 0;
            padding: 0;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .public-section-title svg {
            margin-right: 20px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .schedule-datetime {
            font-size: 38px;
            color: #64b5f6;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* --- Content Area --- */
        .public-schedule-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .public-departures, .public-arrivals {
            flex: 1;
            background: linear-gradient(180deg, rgba(26, 42, 108, 0.4) 0%, rgba(11, 15, 25, 0.6) 100%);
            border-radius: 24px;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(100, 181, 246, 0.25);
            overflow: hidden;
            padding: 5px;
        }

        /* --- Table Styles --- */
        .table-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 20px;
        }

        .public-flight-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed; /* Fixed layout for better control */
        }

        .public-flight-table th {
            background: linear-gradient(180deg, rgba(26, 42, 108, 0.6) 0%, rgba(20, 30, 70, 0.7) 100%);
            color: #d4e5ff;
            text-align: center;
            padding: 18px 10px;
            font-size: 28px;
            font-weight: 600;
            border-bottom: 2px solid rgba(100, 181, 246, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .public-flight-table td {
            padding: 15px 10px;
            border-bottom: 1px solid rgba(26, 42, 108, 0.25);
            word-wrap: break-word;
            vertical-align: middle;
            font-size: 32px;
            background-color: transparent;
            color: #f0f4fa;
            height: 70px;
            box-sizing: border-box;
            text-align: center;
        }

        /* Column widths */
        .public-flight-table th:nth-child(1), .public-flight-table td:nth-child(1) {
            width: 5%; /* Number column */
        }
        
        .public-flight-table th:nth-child(2), .public-flight-table td:nth-child(2) {
            width: 13%; /* Flight number column */
        }
        
        .public-flight-table th:nth-child(3), .public-flight-table td:nth-child(3) {
            width: 15%; /* Airline column */
        }
        
        .public-flight-table th:nth-child(4), .public-flight-table td:nth-child(4) {
            width: 10%; /* Time column */
        }
        
        .public-flight-table th:nth-child(5), .public-flight-table td:nth-child(5) {
            width: 22%; /* Destination column */
        }
        
        .public-flight-table th:nth-child(6), .public-flight-table td:nth-child(6) {
            width: 15%; /* Status column */
        }
        
        .public-flight-table th:nth-child(7), .public-flight-table td:nth-child(7) {
            width: 20%; /* Remarks column */
        }

        /* Center airline column */
        .public-flight-table td.airline-col {
            text-align: center;
        }

        /* Center status column */
        .public-flight-table td.status-col {
            text-align: center;
            font-weight: bold;
        }

        /* Alternating row styling */
        .public-flight-table tbody tr:nth-of-type(even) td {
            background: rgba(26, 42, 108, 0.15);
        }
        
        .public-flight-table tbody tr:hover td {
            background: rgba(26, 42, 108, 0.3);
            transition: background 0.3s ease;
        }

        /* --- Airline info --- */
        .public-airline-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* Airline logo */
        .public-airline-logo {
            width: 110px;
            height: 55px;
            border-radius: 12px;
            object-fit: cover; /* Promijenjeno u contain za bolje prikazivanje logotipa */
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(100, 181, 246, 0.2);
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }

        /* --- Text Styles --- */
        .destination1, .dolazak1, .bilješke1, .brojleta1, .status1 {
            font-size: 32px;
            font-weight: 400;
        }
        .brojleta1 { 
            font-family: 'Consolas', 'Menlo', monospace; 
            color: #bbd6ff; 
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .dolazak1 { 
            color: #f8fafc; 
            font-weight: 600; 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .destination1 { 
            font-weight: 500; 
            color: #ffffff; 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .bilješke1 { 
            color: #b4c6e0; 
            font-style: italic; 
        }

        /* --- Status Box --- */
        .status-box {
            color: white;
            padding: 6px 10px;
            border-radius: 12px;
            display: inline-block;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            min-width: 120px;
            line-height: 1.4;
            box-sizing: border-box;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            letter-spacing: 0.5px;
        }

        /* --- Error Message --- */
        .public-error {
            text-align: center;
            margin: 40px auto;
            max-width: 600px;
            padding: 25px;
            background: rgba(239, 83, 80, 0.15);
            border: 1px solid rgba(239, 83, 80, 0.3);
            border-radius: 15px;
            color: #ffcdd2;
            font-size: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* --- Utility --- */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="public-schedule-container">
        <!-- Header for Departures and Time -->
        <div class="departures-header">
            <h2 class="public-section-title">
                <!-- Departure SVG Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30px" height="30px">
                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
                ODLASCI / DEPARTURES
            </h2>
            <div class="schedule-datetime">
                <span id="current-datetime-display">--:--, --.--.----</span>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="public-error hidden"></div>

        <!-- Content Area (Tables) -->
        <div class="public-schedule-content">
            <!-- Departures Section -->
            <div class="public-departures">
                <div class="table-container">
                    <table class="public-flight-table">
                        <thead>
                            <tr>
                                <th class="narrow-column">BR.</th>
                                <th class="brojleta">LET</th>
                                <th class="airline-col">AVIOKOMPANIJA</th>
                                <th class="vrijeme">VRIJEME</th>
                                <th class="destination-col">DESTINACIJA</th>
                                <th class="status-col">STATUS</th>
                                <th class="remarks-col">NAPOMENE</th>
                            </tr>
                        </thead>
                        <tbody id="departures-body">
                            <!-- Rows will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Header for Arrivals -->
            <div class="arrivals-header">
                <h2 class="public-section-title">
                    <!-- Arrival SVG Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="30px" height="30px">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" transform="rotate(180 12 12)"/>
                    </svg>
                    DOLASCI / ARRIVALS
                </h2>
            </div>

            <!-- Arrivals Section -->
            <div class="public-arrivals">
                <div class="table-container">
                    <table class="public-flight-table">
                        <thead>
                            <tr>
                                <th class="narrow-column">BR.</th>
                                <th class="brojleta">LET</th>
                                <th class="airline-col">AVIOKOMPANIJA</th>
                                <th class="vrijeme">VRIJEME</th>
                                <th class="destination-col">PORIJEKLO</th>
                                <th class="status-col">STATUS</th>
                                <th class="remarks-col">NAPOMENE</th>
                            </tr>
                        </thead>
                        <tbody id="arrivals-body">
                            <!-- Rows will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // --- Konfiguracija ---
            var API_URL = 'http://192.168.18.15:5001/public/daily-schedule';
            var BACKEND_BASE_URL = 'http://192.168.18.15:5001';
            var REFRESH_INTERVAL = 120000; // 2 minute
            var ROWS_PER_PAGE = 3; // Smanjeni broj redova po stranici za ekran 1920x1080
            var ROTATION_INTERVAL = 15000; // Rotacija stranica svakih 15 sekundi
            var DEFAULT_LOGO = '/default-logo.png';
            var MAX_RETRIES = 3;
            var RETRY_DELAY = 5000; // 5 sekundi
            var MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE = 3;
            var consecutiveFetchErrors = 0;
            var allFlights = [];

            // Boje statusa - Koristi oznake za prikaz kao ključeve
            var statusColors = {
                'Scheduled': '#43A9DD',  // Pastelno plava
                'Estimated': '#5DADE2',  // Svjetlo plava
                'Check-in': '#088280',   // Pastelno zelena
                'Check-in Closed': '#F39C12', // Narančasto-žuta
                'Delayed': '#FF8300',    // Pastelno narančasta
                'Boarding': '#703ACF', // Pastelno ljubičasta
                'Gate Closed': '#8E44AD', // Ljubičasta
                'Departed': '#703ACF',  // Pastelno ljubičasta (isto kao boarding)
                'Cancelled': '#DB1F48',   // Pastelno crvena
                'Diverted': '#F95450', // Pastelno koraljno/narančasta
                'Landed': '#088280',   // Pastelno zelena (isto kao on time)
                'default': '#64748b' // Zadana boja pozadine
            };

            // Mapiranje backend statusa na oznake za prikaz
            var statusDisplayLabels = {
                'SCHEDULED': 'Scheduled',
                'ESTIMATED': 'Estimated',
                'ON_TIME': 'Check-in',
                'CHECK_IN_CLOSED': 'Check-in Closed',
                'DELAYED': 'Delayed',
                'BOARDING': 'Boarding',
                'GATE_CLOSED': 'Gate Closed',
                'DEPARTED': 'Departed',
                'CANCELLED': 'Cancelled',
                'DIVERTED': 'Diverted',
                'ARRIVED': 'Landed'
            };

            // --- Stanje ---
            var allFlights = [];
            var currentDeparturePage = 0;
            var currentArrivalPage = 0;
            var rotationTimer = null;
            var dataRefreshTimer = null;
            var consecutiveFetchErrors = 0;
            var MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE = 3;

            // --- DOM elementi ---
            var dateTimeDisplay = document.getElementById('current-datetime-display');
            var departuresTableBody = document.getElementById('departures-body');
            var arrivalsTableBody = document.getElementById('arrivals-body');
            var errorMessage = document.getElementById('error-message');

            // --- Pomoćne funkcije ---
            function padStart(str, targetLength, padString) {
                try {
                    // WebOS 3.x kompatibilnost - sigurnije pretvaranje u string
                    str = String(str || '');
                    
                    // WebOS 3.x kompatibilnost - sigurnije postavljanje defaultne vrijednosti
                    padString = padString || '0';
                    targetLength = targetLength || 2;
                    
                    // Ako je string već dovoljno dugačak, vrati ga
                    if (str.length >= targetLength) return str;
                    
                    // WebOS 3.x kompatibilnost - ne koristi repeat metodu koja možda nije podržana
                    var padding = '';
                    for (var i = 0; i < targetLength; i++) {
                        padding += padString;
                    }
                    
                    return padding.slice(0, targetLength - str.length) + str;
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Greška u padStart funkciji:', e);
                    // Fallback - jednostavno vrati original
                    return String(str || '');
                }
            }

            // --- Formatiranje datuma i vremena - optimizirano za webOS 3.x ---
            function formatDateTimeForDisplay(date) {
                try {
                    if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                        console.error('[RASPORED_DEBUG] Neispravan datum prosljeđen funkciji formatDateTimeForDisplay');
                        date = new Date(); // Koristi trenutni datum kao fallback
                    }
                    
                    // WebOS 3.x kompatibilnost - sigurnije dohvaćanje komponenti datuma
                    var hours, minutes, day, month, year;
                    
                    try {
                        hours = date.getHours();
                        if (isNaN(hours)) hours = 0;
                    } catch (e) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju sati:', e);
                        hours = 0;
                    }
                    
                    try {
                        minutes = date.getMinutes();
                        if (isNaN(minutes)) minutes = 0;
                    } catch (e) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju minuta:', e);
                        minutes = 0;
                    }
                    
                    try {
                        day = date.getDate();
                        if (isNaN(day)) day = 1;
                    } catch (e) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju dana:', e);
                        day = 1;
                    }
                    
                    try {
                        month = date.getMonth() + 1; // Mjeseci su indeksirani od 0
                        if (isNaN(month)) month = 1;
                    } catch (e) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju mjeseca:', e);
                        month = 1;
                    }
                    
                    try {
                        year = date.getFullYear();
                        if (isNaN(year)) year = 2025;
                    } catch (e) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju godine:', e);
                        year = 2025;
                    }
                    
                    // WebOS 3.x kompatibilnost - sigurnije formatiranje brojeva
                    hours = padStart(hours, 2, '0');
                    minutes = padStart(minutes, 2, '0');
                    day = padStart(day, 2, '0');
                    month = padStart(month, 2, '0');
                    
                    // Kombiniraj vrijeme i datum u jedan string s točkom nakon godine
                    var dateTimeString = hours + ':' + minutes + ', ' + day + '.' + month + '.' + year + '.';
                    
                    // WebOS 3.x kompatibilnost - sigurnije ažuriranje DOM-a
                    var dateTimeDisplay = document.getElementById('current-datetime-display');
                    if (dateTimeDisplay) {
                        try {
                            dateTimeDisplay.textContent = dateTimeString;
                        } catch (domError) {
                            console.error('[RASPORED_DEBUG] Greška pri ažuriranju prikaza datuma:', domError);
                            // Fallback za starije preglednike
                            try {
                                dateTimeDisplay.innerText = dateTimeString;
                            } catch (innerTextError) {
                                console.error('[RASPORED_DEBUG] Greška pri ažuriranju innerText:', innerTextError);
                            }
                        }
                    } else {
                        console.error('[RASPORED_DEBUG] Element za prikaz datuma i vremena nije pronađen');
                    }
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Kritična greška u formatDateTimeForDisplay funkciji:', e);
                }
            }

            // --- Formatiranje vremena (sati:minute) - optimizirano za webOS 3.x ---
            function formatTimeHoursMinutes(dateString) {
                try {
                    // WebOS 3.x kompatibilnost - dodatne provjere
                    if (!dateString) {
                        console.warn('[RASPORED_DEBUG] Prazan datum prosljeđen formatTimeHoursMinutes');
                        return '--:--';
                    }
                    
                    var date;
                    try {
                        date = new Date(dateString);
                    } catch (dateError) {
                        console.error('[RASPORED_DEBUG] Greška pri parsiranju datuma:', dateError);
                        return '--:--';
                    }
                    
                    if (!date || isNaN(date.getTime())) {
                        console.warn('[RASPORED_DEBUG] Neispravan format datuma:', dateString);
                        return '--:--';
                    }
                    
                    // WebOS 3.x kompatibilnost - sigurnije dohvaćanje komponenti vremena
                    // Koristi UTC metode za prikaz tačnog vremena iz baze
                    var hours, minutes;
                    
                    try {
                        hours = date.getUTCHours();
                        if (isNaN(hours)) {
                            console.warn('[RASPORED_DEBUG] Neispravni sati:', hours);
                            hours = 0;
                        }
                    } catch (hoursError) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju sati:', hoursError);
                        hours = 0;
                    }
                    
                    try {
                        minutes = date.getUTCMinutes();
                        if (isNaN(minutes)) {
                            console.warn('[RASPORED_DEBUG] Neispravne minute:', minutes);
                            minutes = 0;
                        }
                    } catch (minutesError) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju minuta:', minutesError);
                        minutes = 0;
                    }
                    
                    // Formatiranje s padStart funkcijom
                    var formattedHours = padStart(hours, 2, '0');
                    var formattedMinutes = padStart(minutes, 2, '0');
                    
                    return formattedHours + ':' + formattedMinutes;
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Kritična greška pri formatiranju vremena:', e);
                    return '--:--';
                }
            }

            function showLoading() {
                if (errorMessage) errorMessage.classList.add('hidden');
            }

            // --- Funkcija za prikazivanje greške - optimizirana za webOS 3.x ---
            function showError(message) {
                try {
                    console.log("[RASPORED_DEBUG] showError pozvan s porukom:", message || 'Nepoznata greška');
                    
                    // WebOS 3.x kompatibilnost - sigurnije dohvaćanje DOM elementa
                    var errorMessage = document.getElementById('error-message');
                    
                    if (errorMessage) {
                        try {
                            errorMessage.textContent = message || 'Došlo je do greške';
                            
                            // WebOS 3.x kompatibilnost - sigurnije uklanjanje klase
                            try {
                                errorMessage.classList.remove('hidden');
                            } catch (classError) {
                                console.error('[RASPORED_DEBUG] Greška pri uklanjanju klase:', classError);
                                // Fallback za starije preglednike
                                errorMessage.className = errorMessage.className.replace(/\bhidden\b/g, '').trim();
                            }
                            
                            // Osiguraj da je poruka o grešci vidljiva
                            errorMessage.style.display = 'block';
                        } catch (domError) {
                            console.error('[RASPORED_DEBUG] Greška pri manipulaciji DOM-om:', domError);
                        }
                    } else {
                        console.error('[RASPORED_DEBUG] Element za prikaz greške nije pronađen');
                        // Pokušaj stvoriti element za prikaz greške ako ne postoji
                        try {
                            var newErrorElement = document.createElement('div');
                            newErrorElement.id = 'error-message';
                            newErrorElement.textContent = message || 'Došlo je do greške';
                            newErrorElement.style.position = 'fixed';
                            newErrorElement.style.top = '50%';
                            newErrorElement.style.left = '50%';
                            newErrorElement.style.transform = 'translate(-50%, -50%)';
                            newErrorElement.style.backgroundColor = 'rgba(220, 53, 69, 0.9)';
                            newErrorElement.style.color = 'white';
                            newErrorElement.style.padding = '20px';
                            newErrorElement.style.borderRadius = '10px';
                            newErrorElement.style.zIndex = '9999';
                            newErrorElement.style.textAlign = 'center';
                            newErrorElement.style.fontSize = '24px';
                            newErrorElement.style.boxShadow = '0 0 15px rgba(0, 0, 0, 0.5)';
                            document.body.appendChild(newErrorElement);
                        } catch (createError) {
                            console.error('[RASPORED_DEBUG] Greška pri stvaranju elementa za prikaz greške:', createError);
                        }
                    }
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Kritična greška u showError funkciji:', e);
                }
            }

            function hideStatus() {
                console.log("[RASPORED_DEBUG] hideStatus pozvan.");
                if (errorMessage) errorMessage.classList.add('hidden');
            }

            // --- Funkcija za dobivanje boje statusa - optimizirana za webOS 3.x ---
            function getStatusColor(status) {
                try {
                    // WebOS 3.x kompatibilnost - dodatne provjere
                    if (!status) {
                        console.warn('[RASPORED_DEBUG] Prazan status prosljeđen getStatusColor');
                        return statusColors['default'];
                    }
                    
                    var displayLabel;
                    try {
                        displayLabel = statusDisplayLabels[status] || status;
                    } catch (labelError) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju oznake statusa:', labelError);
                        displayLabel = status;
                    }
                    
                    // Provjeri je li boja definirana za ovaj status
                    var color;
                    try {
                        color = statusColors[displayLabel];
                    } catch (colorError) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju boje za status:', displayLabel, colorError);
                        color = null;
                    }
                    
                    // Ako boja nije definirana, koristi default
                    if (!color) {
                        // Dodatno logiranje za nove statuse
                        if (status === 'ESTIMATED' || status === 'CHECK_IN_CLOSED' || status === 'GATE_CLOSED') {
                            console.warn('[RASPORED_DEBUG] Novi status nema definiranu boju:', status, 'DisplayLabel:', displayLabel);
                        }
                        return statusColors['default'];
                    }
                    
                    return color;
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Kritična greška u getStatusColor funkciji:', e);
                    return '#64748b'; // Hardkodirani fallback
                }
            }
            
            // --- Funkcija za dobivanje oznake statusa za prikaz - optimizirana za webOS 3.x ---
            function getStatusDisplayLabel(status) {
                try {
                    // WebOS 3.x kompatibilnost - dodatne provjere
                    if (!status) {
                        console.warn('[RASPORED_DEBUG] Prazan status prosljeđen getStatusDisplayLabel');
                        return '';
                    }
                    
                    var displayLabel;
                    try {
                        displayLabel = statusDisplayLabels[status];
                    } catch (e) {
                        console.error('[RASPORED_DEBUG] Greška pri dohvaćanju oznake statusa:', e);
                        displayLabel = null;
                    }
                    
                    // Ako oznaka nije definirana, koristi original
                    if (!displayLabel) {
                        // Dodatno logiranje za nove statuse
                        if (status === 'ESTIMATED' || status === 'CHECK_IN_CLOSED' || status === 'GATE_CLOSED') {
                            console.warn('[RASPORED_DEBUG] Novi status nema definiranu oznaku:', status);
                        }
                        return status || '';
                    }
                    
                    return displayLabel;
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Kritična greška u getStatusDisplayLabel funkciji:', e);
                    return status || '';
                }
            }

            // --- Ažuriranje sata - optimizirano za webOS 3.x ---
            function updateClock() {
                try {
                    console.log('[RASPORED_DEBUG] Ažuriranje sata...');
                    var currentDate;
                    
                    try {
                        currentDate = new Date();
                        if (!currentDate || isNaN(currentDate.getTime())) {
                            console.error('[RASPORED_DEBUG] Neispravan datum kreiran u updateClock');
                            // Kreiraj datum na drugi način kao fallback
                            currentDate = new Date(Date.now());
                        }
                    } catch (dateError) {
                        console.error('[RASPORED_DEBUG] Greška pri kreiranju datuma:', dateError);
                        // Hardkodirani datum kao krajnji fallback
                        currentDate = new Date(2025, 5, 3, 15, 31, 39); // 3. lipnja 2025. 15:31:39
                    }
                    
                    formatDateTimeForDisplay(currentDate);
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Kritična greška u updateClock funkciji:', e);
                }
            }

            // --- Dohvaćanje podataka ---
            function fetchData(retryCount) {
                retryCount = retryCount || 0; // Inicijaliziraj broj pokušaja
                console.log('Dohvaćanje podataka o letovima... (Pokušaj ' + (retryCount + 1) + ')');
                showLoading();

                try {
                    var xhr = new XMLHttpRequest();
                    // WebOS 3.x kompatibilnost - koristimo jednostavniji cache buster
                    var urlWithCacheBuster = API_URL + '?t=' + Math.floor(Date.now() / 1000);
                    xhr.open('GET', urlWithCacheBuster, true);
                    // WebOS 3.x kompatibilnost - kraći timeout
                    xhr.timeout = 10000;
                    // WebOS 3.x kompatibilnost - dodajemo potrebne headere
                    xhr.setRequestHeader('Accept', 'application/json');
                    xhr.setRequestHeader('Cache-Control', 'no-cache');

                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                try {
                                    // WebOS 3.x kompatibilnost - provjera praznog odgovora
                                    if (!xhr.responseText || xhr.responseText.trim() === '') {
                                        throw new Error('Prazan odgovor od servera');
                                    }
                                    
                                    // WebOS 3.x kompatibilnost - sigurnije parsiranje JSON-a
                                    var responseText = xhr.responseText;
                                    console.log("[RASPORED_DEBUG] Primljeni odgovor (prvih 100 znakova):", responseText.substring(0, 100));
                                    
                                    var data = JSON.parse(responseText);
                                    console.log("[RASPORED_DEBUG] API podaci parsirani");
                                    
                                    // WebOS 3.x kompatibilnost - sigurnije rukovanje podacima
                                    if (data && Array.isArray(data) && data.length > 0) {
                                        console.log("[RASPORED_DEBUG] Prvi let u podacima - ID:", data[0].id || 'N/A');
                                    }
                                    
                                    if (data && Array.isArray(data)) {
                                        allFlights = data;
                                        consecutiveFetchErrors = 0; // Resetiraj na uspjeh
                                        console.log("[RASPORED_DEBUG] Podaci su niz. Ukupno letova: " + data.length);
                                        hideStatus();
                                        updateTables();
                                    } else {
                                        consecutiveFetchErrors++;
                                        console.error('[RASPORED_DEBUG] Neispravan format podataka (nije niz):', data);
                                        if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE || allFlights.length === 0) {
                                            showError('Greška: Neočekivani format podataka.');
                                        }
                                    }
                                } catch (err) {
                                    consecutiveFetchErrors++;
                                    console.error('[RASPORED_DEBUG] Greška pri parsiranju JSON-a:', err.message, 'Response Text:', xhr.responseText.substring(0, 500));
                                    if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE || allFlights.length === 0) {
                                        showError('Greška pri obradi podataka.');
                                    }
                                }
                            } else { // Rukovanje HTTP greškama (non-200 status)
                                console.error('[RASPORED_DEBUG] API zahtjev nije uspio s HTTP statusom:', xhr.status, xhr.statusText, 'Response Text:', xhr.responseText.substring(0, 500));
                                var errorMsg = 'Greška servera (' + xhr.status + ') pri dobavljanju podataka.';
                                if (retryCount < MAX_RETRIES) {
                                    console.warn(errorMsg + ' Pokušavam ponovo za ' + RETRY_DELAY / 1000 + 's...');
                                    setTimeout(function() { fetchData(retryCount + 1); }, RETRY_DELAY);
                                } else {
                                    consecutiveFetchErrors++;
                                    console.error('Maksimalan broj pokušaja dostignut za HTTP grešku.');
                                    if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE) {
                                        showError(errorMsg);
                                    }
                                }
                            }
                        }
                    };

                    xhr.onerror = function() { // Rukovanje mrežnim greškama
                        console.error('[RASPORED_DEBUG] Došlo je do mrežne greške.');
                        var errorMsg = 'Mrežna greška pri dobavljanju podataka.';
                        if (retryCount < MAX_RETRIES) {
                            console.warn(errorMsg + ' Pokušavam ponovo za ' + RETRY_DELAY / 1000 + 's...');
                            setTimeout(function() { fetchData(retryCount + 1); }, RETRY_DELAY);
                        } else {
                            consecutiveFetchErrors++;
                            console.error('Maksimalan broj pokušaja dostignut za mrežnu grešku.');
                            if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE) {
                                showError(errorMsg + ' Proverite konekciju.');
                            }
                        }
                    };

                    xhr.ontimeout = function () { // Rukovanje timeoutima
                        console.error('[RASPORED_DEBUG] Zahtjev je istekao.');
                        var errorMsg = 'Zahtev je istekao.';
                        if (retryCount < MAX_RETRIES) {
                            console.warn(errorMsg + ' Pokušavam ponovo za ' + RETRY_DELAY / 1000 + 's...');
                            setTimeout(function() { fetchData(retryCount + 1); }, RETRY_DELAY);
                        } else {
                            consecutiveFetchErrors++;
                            console.error('Maksimalan broj pokušaja dostignut za timeout.');
                            if (consecutiveFetchErrors >= MAX_CONSECUTIVE_ERRORS_BEFORE_SHOWING_MESSAGE) {
                                showError(errorMsg);
                            }
                        }
                    };

                    xhr.send();
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Iznimka pri dohvaćanju podataka:', e);
                    if (retryCount < MAX_RETRIES) {
                        console.warn('Pokušavam ponovo za ' + RETRY_DELAY / 1000 + 's...');
                        setTimeout(function() { fetchData(retryCount + 1); }, RETRY_DELAY);
                    } else {
                        showError('Greška pri dohvaćanju podataka. Provjerite konekciju.');
                    }
                }
            }

            // --- Renderiranje redova tabele - optimizirano za webOS 3.x ---
            function renderTableRows(tbodyElement, flights, currentPage, rowsPerPage) {
                try {
                    // WebOS 3.x kompatibilnost - dodatne provjere
                    if (!tbodyElement) {
                        console.error('[RASPORED_DEBUG] tbodyElement je null ili undefined');
                        return;
                    }
                    
                    if (!flights) {
                        console.error('[RASPORED_DEBUG] flights je null ili undefined');
                        return;
                    }
                    
                    // WebOS 3.x kompatibilnost - sigurnije čišćenje tablice
                    while (tbodyElement.firstChild) {
                        tbodyElement.removeChild(tbodyElement.firstChild);
                    }

                    // Izračunaj indekse za trenutnu stranicu
                    var startIndex = currentPage * rowsPerPage;
                    var endIndex = Math.min(startIndex + rowsPerPage, flights.length);
                    
                    console.log('[RASPORED_DEBUG] Renderiranje redova od', startIndex, 'do', endIndex, 'od ukupno', flights.length);

                    // Dodaj redove za trenutnu stranicu
                    for (var i = startIndex; i < endIndex; i++) {
                        var flight = flights[i];
                        var row = document.createElement('tr');

                        // Broj reda
                        var indexCell = document.createElement('td');
                        indexCell.textContent = (i + 1) + '.';
                        row.appendChild(indexCell);

                        // Broj leta
                        var flightNumberCell = document.createElement('td');
                        flightNumberCell.className = 'brojleta1';
                        // Koristi flight_number iz objekta
                        flightNumberCell.textContent = flight.flight_number || 'N/A';
                        row.appendChild(flightNumberCell);

                        // Aviokompanija (samo logo)
                        var airlineCell = document.createElement('td');
                        airlineCell.className = 'airline-col';
                        var airlineInfo = document.createElement('div');
                        airlineInfo.className = 'public-airline-info';

                        // Logo aviokompanije - optimizirano za webOS 3.x
                        var logoImg = document.createElement('img');
                        logoImg.className = 'public-airline-logo';
                        
                        // WebOS 3.x kompatibilnost - postavi default vrijednosti odmah
                        logoImg.alt = 'Airline';
                        logoImg.src = DEFAULT_LOGO;
                        
                        try {
                            // Provjeri je li Airline objekt dostupan i sadrži logo_url
                            if (flight && flight.Airline && flight.Airline.logo_url) {
                                // Provjeri počinje li putanja s /
                                var logoPath = flight.Airline.logo_url;
                                var fullLogoPath = '';
                                
                                if (logoPath.indexOf('/') === 0) {
                                    fullLogoPath = BACKEND_BASE_URL + logoPath;
                                } else {
                                    fullLogoPath = BACKEND_BASE_URL + '/' + logoPath;
                                }
                                
                                // WebOS 3.x kompatibilnost - postavi src tek nakon što je putanja potpuno formirana
                                logoImg.src = fullLogoPath;
                                if (flight.Airline.name) {
                                    logoImg.alt = flight.Airline.name;
                                }
                            } else if (flight && flight.airline_logo) {
                                logoImg.src = BACKEND_BASE_URL + flight.airline_logo;
                                if (flight.airline_name) {
                                    logoImg.alt = flight.airline_name;
                                }
                            }
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri postavljanju logotipa:', e);
                        }
                        
                        // WebOS 3.x kompatibilnost - poboljšano rukovanje greškama za slike
                        logoImg.onerror = function() { 
                            console.log('[RASPORED_DEBUG] Greška pri učitavanju logotipa, koristi se default');
                            this.src = DEFAULT_LOGO; 
                            this.style.width = '100px'; 
                            this.style.height = '50px'; 
                        };
                        
                        airlineInfo.appendChild(logoImg);

                        airlineCell.appendChild(airlineInfo);
                        row.appendChild(airlineCell);

                        // Vrijeme
                        var timeCell = document.createElement('td');
                        timeCell.className = 'dolazak1';
                        var timeValue = flight.is_departure ? flight.departure_time : flight.arrival_time;
                        timeCell.textContent = formatTimeHoursMinutes(timeValue);
                        row.appendChild(timeCell);

                        // Destinacija/Porijeklo
                        var destinationCell = document.createElement('td');
                        destinationCell.className = 'destination1';
                        
                        // Koristi DestinationInfo objekt za prikaz destinacije/porijekla - optimizirano za webOS 3.x
                        var destinationText = 'N/A'; // WebOS 3.x kompatibilnost - postavi default vrijednost odmah
                        
                        try {
                            // WebOS 3.x kompatibilnost - dodatne provjere
                            if (flight && flight.DestinationInfo && typeof flight.DestinationInfo === 'object' && flight.DestinationInfo.name) {
                                destinationText = flight.DestinationInfo.name;
                                // Dodaj kod aerodroma ako postoji
                                if (flight.DestinationInfo.code) {
                                    destinationText += ' (' + flight.DestinationInfo.code + ')';
                                }
                                console.log('[RASPORED_DEBUG] Destinacija iz DestinationInfo:', destinationText);
                            } else if (flight && flight.destination_id_new) {
                                // Ako imamo samo ID destinacije, pokušamo prikazati barem taj podatak
                                destinationText = 'Dest. ID: ' + flight.destination_id_new;
                                console.log('[RASPORED_DEBUG] Destinacija iz destination_id_new:', destinationText);
                            } else if (flight && flight.destination) {
                                destinationText = flight.destination;
                                console.log('[RASPORED_DEBUG] Destinacija iz destination:', destinationText);
                            } else {
                                console.log('[RASPORED_DEBUG] Nema podataka o destinaciji za let:', flight ? flight.flight_number : 'nepoznat');
                            }
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri dohvaćanju destinacije:', e);
                        }
                        
                        destinationCell.textContent = destinationText;
                        row.appendChild(destinationCell);

                        // Status - optimizirano za webOS 3.x
                        var statusCell = document.createElement('td');
                        statusCell.className = 'status-col';
                        var statusBox = document.createElement('div');
                        statusBox.className = 'status-box';
                        
                        try {
                            // WebOS 3.x kompatibilnost - sigurnije dohvaćanje statusa
                            var statusValue = (flight && flight.status) ? flight.status : 'UNKNOWN';
                            var statusColor = getStatusColor(statusValue);
                            var statusLabel = getStatusDisplayLabel(statusValue);
                            
                            console.log('[RASPORED_DEBUG] Status leta ' + (flight ? flight.flight_number : 'nepoznat') + ':', statusValue, statusLabel, statusColor);
                            
                            statusBox.style.backgroundColor = statusColor;
                            statusBox.textContent = statusLabel;
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri postavljanju statusa:', e);
                            statusBox.style.backgroundColor = statusColors['default'];
                            statusBox.textContent = 'N/A';
                        }
                        
                        statusCell.appendChild(statusBox);
                        row.appendChild(statusCell);

                        // Napomene
                        var remarksCell = document.createElement('td');
                        remarksCell.className = 'bilješke1';
                        remarksCell.textContent = flight.remarks || '';
                        row.appendChild(remarksCell);

                        tbodyElement.appendChild(row);
                    }

                    // Dodaj prazne redove ako je potrebno da se popuni stranica
                    var emptyRowsNeeded = rowsPerPage - (endIndex - startIndex);
                    for (var j = 0; j < emptyRowsNeeded; j++) {
                        var emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td>';
                        tbodyElement.appendChild(emptyRow);
                    }
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Greška pri renderiranju redova tabele:', e);
                }
            }

            // --- Ažuriranje tabela - optimizirano za webOS 3.x ---
            function updateTables() {
                try {
                    // WebOS 3.x kompatibilnost - dodatne provjere
                    if (!allFlights) {
                        console.error('[RASPORED_DEBUG] allFlights je null ili undefined');
                        showError('Greška: Nema podataka o letovima.');
                        return;
                    }
                    
                    if (!Array.isArray(allFlights)) {
                        console.error('[RASPORED_DEBUG] allFlights nije niz');
                        showError('Greška: Neispravan format podataka.');
                        return;
                    }
                    
                    // Dodaj logiranje za debug
                    console.log('[RASPORED_DEBUG] Ukupno letova:', allFlights.length);
                    
                    // WebOS 3.x kompatibilnost - sigurnije logiranje
                    if (allFlights.length > 0) {
                        try {
                            console.log('[RASPORED_DEBUG] Prvi let - ID:', allFlights[0].id || 'N/A');
                            console.log('[RASPORED_DEBUG] Prvi let - Broj leta:', allFlights[0].flight_number || 'N/A');
                            
                            // Detaljnije logiranje strukture podataka
                            if (allFlights[0].DestinationInfo && typeof allFlights[0].DestinationInfo === 'object') {
                                console.log('[RASPORED_DEBUG] DestinationInfo prisutan');
                                console.log('[RASPORED_DEBUG] DestinationInfo.name:', allFlights[0].DestinationInfo.name || 'N/A');
                            } else {
                                console.log('[RASPORED_DEBUG] DestinationInfo nije prisutan ili nije objekt');
                            }
                            
                            if (allFlights[0].Airline && typeof allFlights[0].Airline === 'object') {
                                console.log('[RASPORED_DEBUG] Airline prisutan');
                                console.log('[RASPORED_DEBUG] Airline.name:', allFlights[0].Airline.name || 'N/A');
                            } else {
                                console.log('[RASPORED_DEBUG] Airline nije prisutan ili nije objekt');
                            }
                            
                            // Logiranje ključnih polja
                            console.log('[RASPORED_DEBUG] Je li odlazak:', allFlights[0].is_departure !== undefined ? allFlights[0].is_departure : 'N/A');
                        } catch (logError) {
                            console.error('[RASPORED_DEBUG] Greška pri logiranju detalja leta:', logError);
                        }
                    }
                    
                    // WebOS 3.x kompatibilnost - sigurnije filtriranje
                    var departures = [];
                    var arrivals = [];
                    
                    try {
                        // Koristi for petlju umjesto filter za bolju kompatibilnost
                        for (var i = 0; i < allFlights.length; i++) {
                            var flight = allFlights[i];
                            if (flight && flight.is_departure === true) {
                                departures.push(flight);
                            } else if (flight && flight.is_departure === false) {
                                arrivals.push(flight);
                            } else {
                                console.warn('[RASPORED_DEBUG] Let bez definiranog is_departure:', flight ? flight.flight_number : 'nepoznat');
                            }
                        }
                    } catch (filterError) {
                        console.error('[RASPORED_DEBUG] Greška pri filtriranju letova:', filterError);
                    }
                    
                    console.log('[RASPORED_DEBUG] Odlasci:', departures.length, 'Dolasci:', arrivals.length);

                    // WebOS 3.x kompatibilnost - sigurnije računanje stranica
                    var totalDeparturePages = departures.length > 0 ? Math.ceil(departures.length / ROWS_PER_PAGE) : 1;
                    var totalArrivalPages = arrivals.length > 0 ? Math.ceil(arrivals.length / ROWS_PER_PAGE) : 1;

                    // Osiguraj da je trenutni indeks stranice validan
                    if (currentDeparturePage >= totalDeparturePages) {
                        currentDeparturePage = 0;
                    }
                    
                    if (currentArrivalPage >= totalArrivalPages) {
                        currentArrivalPage = 0;
                    }

                    console.log('[RASPORED_DEBUG] Ažuriranje tabela. Stranica odlazaka:', (currentDeparturePage + 1), '/', totalDeparturePages, 'Stranica dolazaka:', (currentArrivalPage + 1), '/', totalArrivalPages);

                    // WebOS 3.x kompatibilnost - provjera DOM elemenata
                    if (!departuresTableBody) {
                        console.error('[RASPORED_DEBUG] departuresTableBody nije pronađen');
                        return;
                    }
                    
                    if (!arrivalsTableBody) {
                        console.error('[RASPORED_DEBUG] arrivalsTableBody nije pronađen');
                        return;
                    }

                    // Odlasci
                    if (!departures || departures.length === 0) {
                        // WebOS 3.x kompatibilnost - sigurnije postavljanje innerHTML
                        try {
                            departuresTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; font-style:italic;">Nema odlazaka za danas.</td></tr>';
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri postavljanju prazne poruke za odlaske:', e);
                        }
                    } else {
                        try {
                            renderTableRows(departuresTableBody, departures, currentDeparturePage, ROWS_PER_PAGE);
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri renderiranju redova odlazaka:', e);
                        }
                    }

                    // Dolasci
                    if (!arrivals || arrivals.length === 0) {
                        // WebOS 3.x kompatibilnost - sigurnije postavljanje innerHTML
                        try {
                            arrivalsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; font-style:italic;">Nema dolazaka za danas.</td></tr>';
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri postavljanju prazne poruke za dolaske:', e);
                        }
                    } else {
                        try {
                            renderTableRows(arrivalsTableBody, arrivals, currentArrivalPage, ROWS_PER_PAGE);
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri renderiranju redova dolazaka:', e);
                        }
                    }

                    // Pokreni timer za rotaciju ako već nije pokrenut ili ga treba resetirati
                    startRotationTimer(totalDeparturePages, totalArrivalPages);
                    hideStatus();
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Greška pri ažuriranju tabela:', e);
                }
            }

            // --- Funkcija za rotaciju stranica - optimizirana za webOS 3.x ---
            function rotatePages(totalDeparturePages, totalArrivalPages) {
                try {
                    console.log('[RASPORED_DEBUG] Rotacija stranica. Trenutno: Odlasci=' + currentDeparturePage + ', Dolasci=' + currentArrivalPage);
                    
                    // WebOS 3.x kompatibilnost - sigurnije računanje sledeće stranice
                    if (totalDeparturePages > 1) {
                        currentDeparturePage = currentDeparturePage + 1;
                        if (currentDeparturePage >= totalDeparturePages) {
                            currentDeparturePage = 0;
                        }
                    }
                    
                    if (totalArrivalPages > 1) {
                        currentArrivalPage = currentArrivalPage + 1;
                        if (currentArrivalPage >= totalArrivalPages) {
                            currentArrivalPage = 0;
                        }
                    }
                    
                    console.log('[RASPORED_DEBUG] Nove stranice: Odlasci=' + currentDeparturePage + ', Dolasci=' + currentArrivalPage);
                    
                    // WebOS 3.x kompatibilnost - odgađamo ažuriranje za mali vremenski period
                    setTimeout(function() {
                        try {
                            updateTables(); // Ponovno renderiranje tabela s novim indeksima stranica
                        } catch (updateError) {
                            console.error('[RASPORED_DEBUG] Greška pri ažuriranju tablica nakon rotacije:', updateError);
                        }
                    }, 50); // Kratka odgoda za bolju kompatibilnost
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Greška pri rotaciji stranica:', e);
                }
            }

            // --- Funkcija za pokretanje/resetiranje timera za rotaciju - optimizirana za webOS 3.x ---
            function startRotationTimer(totalDeparturePages, totalArrivalPages) {
                try {
                    // Očisti postojeći timer
                    if (rotationTimer) {
                        clearTimeout(rotationTimer);
                        rotationTimer = null;
                    }
                    
                    // Pokreni timer samo ako ima više od jedne stranice u bilo kojoj tabeli
                    if (totalDeparturePages > 1 || totalArrivalPages > 1) {
                        console.log('Pokretanje timera za rotaciju stranica. Interval:', ROTATION_INTERVAL);
                        
                        // Koristi setTimeout za bolju kompatibilnost s webOS 3.x
                        function scheduleNextRotation() {
                            try {
                                rotationTimer = setTimeout(function() {
                                    try {
                                        rotatePages(totalDeparturePages, totalArrivalPages);
                                        // Planiraj sljedeću rotaciju
                                        scheduleNextRotation();
                                    } catch (e) {
                                        console.error('[RASPORED_DEBUG] Greška u callback funkciji timera za rotaciju:', e);
                                        // Pokušaj ponovno pokrenuti rotaciju nakon kratke pauze
                                        setTimeout(scheduleNextRotation, 5000);
                                    }
                                }, ROTATION_INTERVAL);
                            } catch (e) {
                                console.error('[RASPORED_DEBUG] Greška pri planiranju sljedeće rotacije:', e);
                            }
                        }
                        
                        // Pokreni ciklus rotacije
                        scheduleNextRotation();
                    } else {
                        console.log('Nema potrebe za rotacijom stranica (jedna stranica ili prazno).');
                        rotationTimer = null;
                    }
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Greška pri pokretanju timera za rotaciju:', e);
                }
            }

            // --- Inicijalizacija - optimizirana za webOS 3.x ---
            try {
                console.log('[RASPORED_DEBUG] Početak inicijalizacije aplikacije...');
                
                // WebOS 3.x kompatibilnost - dohvati i provjeri DOM elemente
                var departuresTableBody = document.getElementById('departures-body');
                var arrivalsTableBody = document.getElementById('arrivals-body');
                var dateTimeDisplay = document.getElementById('current-datetime-display');
                var errorMessage = document.getElementById('error-message');
                
                if (!departuresTableBody) {
                    console.error('[RASPORED_DEBUG] Kritični element nije pronađen: departures-body');
                }
                
                if (!arrivalsTableBody) {
                    console.error('[RASPORED_DEBUG] Kritični element nije pronađen: arrivals-body');
                }
                
                if (!dateTimeDisplay) {
                    console.error('[RASPORED_DEBUG] Kritični element nije pronađen: current-datetime-display');
                }
                
                if (!errorMessage) {
                    console.error('[RASPORED_DEBUG] Element nije pronađen: error-message');
                }
                
                if (!departuresTableBody || !arrivalsTableBody || !dateTimeDisplay) {
                    console.error("[RASPORED_DEBUG] Kritični DOM elementi nisu pronađeni. Prekidam inicijalizaciju.");
                    if (errorMessage) {
                        errorMessage.textContent = "Greška pri inicijalizaciji prikaza.";
                        errorMessage.classList.remove('hidden');
                    }
                    return;
                }

                // Ažuriraj sat
                console.log('[RASPORED_DEBUG] Pokretanje sata...');
                try {
                    updateClock();
                    // WebOS 3.x kompatibilnost - koristimo setTimeout umjesto setInterval
                    function scheduleClock() {
                        setTimeout(function() {
                            try {
                                updateClock();
                                scheduleClock(); // Rekurzivno planiranje
                            } catch (clockError) {
                                console.error('[RASPORED_DEBUG] Greška pri ažuriranju sata:', clockError);
                                scheduleClock(); // Nastavi i u slučaju greške
                            }
                        }, 1000);
                    }
                    scheduleClock();
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Greška pri inicijalizaciji sata:', e);
                }

                // Početno dohvaćanje podataka
                console.log('[RASPORED_DEBUG] Početno dohvaćanje podataka...');
                try {
                    fetchData(0);
                } catch (e) {
                    console.error('[RASPORED_DEBUG] Greška pri početnom dohvaćanju podataka:', e);
                }
                
                // WebOS 3.x kompatibilnost - periodično dohvaćanje podataka sa setTimeout
                console.log('[RASPORED_DEBUG] Postavljanje periodičnog dohvaćanja podataka...');
                function scheduleDataRefresh() {
                    dataRefreshTimer = setTimeout(function() { 
                        try {
                            console.log('[RASPORED_DEBUG] Periodično dohvaćanje podataka...');
                            fetchData(0); 
                            scheduleDataRefresh(); // Rekurzivno planiranje
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri periodičnom dohvaćanju podataka:', e);
                            scheduleDataRefresh(); // Nastavi i u slučaju greške
                        }
                    }, REFRESH_INTERVAL);
                }
                scheduleDataRefresh();

                // --- Periodično osvježavanje stranice - optimizirano za webOS 3.x ---
                console.log('[RASPORED_DEBUG] Postavljanje periodičnog osvježavanja stranice...');
                
                function checkAndPerformRefresh() {
                    try {
                        var now = new Date();
                        var hour = now.getHours();
                        var minute = now.getMinutes();

                        // Provjeri za 4:00, 8:00 ili 16:00
                        if ((hour === 4 || hour === 8 || hour === 16) && minute === 0) {
                            console.log('[RASPORED_DEBUG] Izvršavanje planiranog osvježavanja u ' + hour + ':00...');
                            try {
                                // WebOS 3.x kompatibilnost - sigurnije osvježavanje
                                setTimeout(function() {
                                    window.location.reload(true); // Prisilno osvježavanje sa servera
                                }, 1000);
                            } catch (reloadError) {
                                console.error('[RASPORED_DEBUG] Greška pri osvježavanju stranice:', reloadError);
                            }
                        }
                    } catch (e) {
                        console.error('[RASPORED_DEBUG] Greška pri provjeri za osvježavanje:', e);
                    }
                    
                    // WebOS 3.x kompatibilnost - rekurzivno planiranje
                    setTimeout(checkAndPerformRefresh, 60000);
                }
                
                // WebOS 3.x kompatibilnost - počni s malom odgodom
                setTimeout(checkAndPerformRefresh, 5000);
                console.log('Aktivna provjera planiranog osvježavanja za 4:00, 8:00 i 16:00.');

                // --- Funkcija za čišćenje resursa kada se stranica isključi - optimizirana za webOS 3.x ---
                console.log('[RASPORED_DEBUG] Postavljanje handlera za čišćenje resursa...');
                
                try {
                    window.addEventListener('beforeunload', function() {
                        try {
                            console.log('[RASPORED_DEBUG] Čišćenje resursa prije zatvaranja stranice...');
                            
                            // WebOS 3.x kompatibilnost - provjera i čišćenje timera
                            if (dataRefreshTimer) {
                                try {
                                    clearTimeout(dataRefreshTimer); // Promijenjeno iz clearInterval u clearTimeout
                                    console.log('[RASPORED_DEBUG] dataRefreshTimer očišćen');
                                } catch (timerError) {
                                    console.error('[RASPORED_DEBUG] Greška pri čišćenju dataRefreshTimer:', timerError);
                                }
                                dataRefreshTimer = null;
                            }
                            
                            if (rotationTimer) {
                                try {
                                    clearTimeout(rotationTimer);
                                    console.log('[RASPORED_DEBUG] rotationTimer očišćen');
                                } catch (timerError) {
                                    console.error('[RASPORED_DEBUG] Greška pri čišćenju rotationTimer:', timerError);
                                }
                                rotationTimer = null;
                            }
                        } catch (e) {
                            console.error('[RASPORED_DEBUG] Greška pri čišćenju resursa:', e);
                        }
                    });
                    console.log('[RASPORED_DEBUG] Handler za beforeunload postavljen');
                } catch (eventError) {
                    console.error('[RASPORED_DEBUG] Greška pri postavljanju beforeunload handlera:', eventError);
                }
                
                // --- Rukovanje globalnim greškama - optimizirano za webOS 3.x ---
                console.log('[RASPORED_DEBUG] Postavljanje handlera za globalne greške...');
                
                try {
                    window.addEventListener('error', function(e) {
                        try {
                            var errorMsg = e && e.message ? e.message : 'Nepoznata greška';
                            var errorSrc = e && e.filename ? e.filename : 'Nepoznat izvor';
                            var errorLine = e && e.lineno ? e.lineno : 'Nepoznata linija';
                            
                            console.error('[RASPORED_DEBUG] Globalna greška uhvaćena:', errorMsg, 'u', errorSrc, 'linija', errorLine);
                            
                            // Pokušaj ponovno pokrenuti rotaciju ako dođe do greške
                            try {
                                if (rotationTimer) {
                                    clearTimeout(rotationTimer);
                                    rotationTimer = null;
                                }
                                // Pokušaj ponovno pokrenuti rotaciju nakon pauze
                                setTimeout(function() {
                                    try {
                                        updateTables();
                                    } catch (err) {
                                        console.error('[RASPORED_DEBUG] Greška pri ponovnom pokretanju rotacije:', err);
                                    }
                                }, 5000);
                            } catch (err) {
                                console.error('[RASPORED_DEBUG] Greška pri rukovanju globalnom greškom:', err);
                            }
                            return true; // Dozvoli zadano rukovanje greškama da se nastavi
                        } catch (errorHandlingError) {
                            console.error('[RASPORED_DEBUG] Greška pri obradi globalne greške:', errorHandlingError);
                            return true;
                        }
                    });
                } catch (eventError) {
                    console.error('[RASPORED_DEBUG] Greška pri postavljanju error handlera:', eventError);
                }

                console.log('Prikaz rasporeda letova inicijaliziran s webOS 3.x kompatibilnošću.');
            } catch (e) {
                console.error('[RASPORED_DEBUG] Greška pri inicijalizaciji:', e);
                showError("Greška pri inicijalizaciji prikaza.");
            }
        })();
    </script>
</body>
</html>